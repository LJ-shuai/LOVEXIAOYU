<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3Dæ¨¡å‹æŸ¥çœ‹å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/es-module-shims@1.6.3/dist/es-module-shims.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <style>
    body { margin: 0; overflow: hidden; font-family: 'Microsoft YaHei', sans-serif; }
    .toolbar {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      z-index: 100;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    button, input[type="file"] {
      padding: 8px 16px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    button:hover, input[type="file"]:hover {
      background-color: #0b7dda;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    input[type="file"] {
      background-color: #4CAF50;
    }
    input[type="file"]::file-selector-button {
      background: white;
      color: #4CAF50;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      transition: all 0.3s;
    }
    input[type="file"]::file-selector-button:hover {
      background: #f0f0f0;
    }
    #share-url {
      position: absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 4px;
      font-size: 14px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #share-url::before {
      content: "ğŸ”— åˆ†äº«é“¾æ¥:";
      margin-right: 8px;
      font-weight: bold;
    }
    #loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 18px;
      z-index: 200;
      flex-direction: column;
      gap: 16px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid white;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #error-message {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 12px 16px;
      background-color: #f44336;
      color: white;
      border-radius: 4px;
      display: none;
      z-index: 200;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transform: translateY(-20px);
      opacity: 0;
      transition: all 0.3s;
    }
    #error-message.show {
      transform: translateY(0);
      opacity: 1;
    }
    #debug-info {
      position: absolute;
      bottom: 50px;
      left: 10px;
      right: 10px;
      padding: 8px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 4px;
      font-size: 12px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    #toggle-debug {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 150;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <input type="file" id="file-input" accept=".glb" />
    <button id="share-btn" onclick="window.generateShareUrl()">
      <i class="fa fa-share-alt"></i> ç”Ÿæˆåˆ†äº«é“¾æ¥
    </button>
    <button id="reset-btn" onclick="window.resetViewer()">
      <i class="fa fa-refresh"></i> é‡ç½®è§†å›¾
    </button>
  </div>
  <div id="share-url"></div>
  <div id="loading">
    <div class="spinner"></div>
    <div>åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</div>
  </div>
  <div id="error-message"></div>
  <div id="debug-info"></div>
  <button id="toggle-debug" onclick="toggleDebugInfo()">è°ƒè¯•ä¿¡æ¯</button>
  <div id="container"></div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    // å¯¼å…¥Three.jsæ¨¡å—
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // è°ƒè¯•æ¨¡å¼
    const DEBUG_MODE = true;
    let debugInfo = [];

    // åˆå§‹åŒ–Three.js
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f0f0);
    
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
    camera.position.z = 5;
    
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('container').appendChild(renderer.domElement);
    
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    
    // æ·»åŠ å…‰æº
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(5, 5, 5);
    scene.add(directionalLight);
    
    // åˆå§‹åŒ–å˜é‡
    let currentModel = null;
    let modelDataUrl = null;
    let initialCameraPosition = camera.position.clone();
    let initialControlsTarget = controls.target.clone();
    
    // æ˜¾ç¤º/éšè—åŠ è½½æŒ‡ç¤ºå™¨
    function showLoading(visible) {
      document.getElementById('loading').style.display = visible ? 'flex' : 'none';
      logDebug(`Loading: ${visible}`);
    }
    
    // æ˜¾ç¤º/éšè—é”™è¯¯æ¶ˆæ¯
    function showError(message) {
      const errorElement = document.getElementById('error-message');
      errorElement.textContent = message;
      errorElement.style.backgroundColor = '#f44336';
      errorElement.classList.add('show');
      logDebug(`Error: ${message}`);
      
      // 5ç§’åè‡ªåŠ¨éšè—é”™è¯¯æ¶ˆæ¯
      setTimeout(() => {
        errorElement.classList.remove('show');
      }, 5000);
    }
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccess(message) {
      const errorElement = document.getElementById('error-message');
      errorElement.textContent = message;
      errorElement.style.backgroundColor = '#4CAF50';
      errorElement.classList.add('show');
      logDebug(`Success: ${message}`);
      
      // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
      setTimeout(() => {
        errorElement.classList.remove('show');
      }, 3000);
    }
    
    // åŠ è½½æœ¬åœ°GLBæ–‡ä»¶
    document.getElementById('file-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) {
        logDebug('No file selected');
        return;
      }
      
      logDebug(`Selected file: ${file.name}, size: ${formatFileSize(file.size)}`);
      
      showLoading(true);
      hideElement('share-url');
      
      const reader = new FileReader();
      reader.onload = function(event) {
        logDebug('File loaded successfully');
        const arrayBuffer = event.target.result;
        
        // è½¬æ¢ä¸ºData URLä»¥ä¾¿åˆ†äº«
        const base64 = arrayBufferToBase64(arrayBuffer);
        modelDataUrl = `data:model/gltf-binary;base64,${base64}`;
        logDebug(`Model DataURL generated (length: ${modelDataUrl.length})`);
        
        // åŠ è½½æ¨¡å‹
        const loader = new GLTFLoader();
        logDebug('Starting model parsing...');
        loader.parse(arrayBuffer, '', function(gltf) {
          logDebug('Model parsed successfully');
          loadModel(gltf.scene);
        }, function(error) {
          console.error('åŠ è½½é”™è¯¯:', error);
          showLoading(false);
          showError(`æ¨¡å‹è§£æå¤±è´¥: ${error.message}`);
          modelDataUrl = null; // é‡ç½®æ¨¡å‹æ•°æ®
          logDebug(`Model parsing error: ${error.message}`);
        });
      };
      
      reader.onerror = function(error) {
        console.error('æ–‡ä»¶è¯»å–é”™è¯¯:', error);
        showLoading(false);
        showError(`æ–‡ä»¶è¯»å–å¤±è´¥: ${error.message}`);
        logDebug(`File reading error: ${error.message}`);
      };
      
      reader.readAsArrayBuffer(file);
    });
    
    // åŠ è½½æ¨¡å‹åˆ°åœºæ™¯
    function loadModel(model) {
      if (currentModel) {
        scene.remove(currentModel);
        logDebug('Removed previous model from scene');
      }
      
      currentModel = model;
      logDebug(`Model loaded: ${model.name || 'unnamed'}`);
      
      // è‡ªåŠ¨è°ƒæ•´ç›¸æœº
      const box = new THREE.Box3().setFromObject(currentModel);
      const center = box.getCenter(new THREE.Vector3());
      const size = box.getSize(new THREE.Vector3());
      
      logDebug(`Model bounds: min(${box.min.x}, ${box.min.y}, ${box.min.z}) max(${box.max.x}, ${box.max.y}, ${box.max.z})`);
      logDebug(`Model size: ${size.x} x ${size.y} x ${size.z}`);
      
      if (size.x === 0 && size.y === 0 && size.z === 0) {
        showError('æ¨¡å‹å°ºå¯¸ä¸ºé›¶ï¼Œæ— æ³•æ­£ç¡®æ˜¾ç¤º');
        logDebug('Model size is zero, cannot be displayed properly');
        return;
      }
      
      currentModel.position.sub(center); // å±…ä¸­æ¨¡å‹
      
      const maxDim = Math.max(size.x, size.y, size.z);
      camera.position.set(0, 0, maxDim * 2);
      camera.lookAt(0, 0, 0);
      
      // ä¿å­˜åˆå§‹ç›¸æœºä½ç½®å’Œæ§åˆ¶å™¨ç›®æ ‡
      initialCameraPosition = camera.position.clone();
      initialControlsTarget = controls.target.clone();
      
      scene.add(currentModel);
      showLoading(false);
      showSuccess('æ¨¡å‹åŠ è½½æˆåŠŸï¼');
      logDebug('Model added to scene and loading completed');
    }
    
    // ç”Ÿæˆåˆ†äº«é“¾æ¥
    function generateShareUrl() {
      logDebug('Generate share URL button clicked');
      
      // æ·»åŠ é¢å¤–æ£€æŸ¥ç¡®ä¿å˜é‡å·²åˆå§‹åŒ–
      if (!modelDataUrl) {
        showError('è¯·å…ˆä¸Šä¼ ä¸€ä¸ªGLBæ–‡ä»¶');
        logDebug('Share URL generation failed: No model loaded');
        return;
      }
      
      try {
        const baseUrl = window.location.origin + window.location.pathname;
        const shareUrl = `${baseUrl}?model=${encodeURIComponent(modelDataUrl)}`;
        logDebug(`Generated share URL (length: ${shareUrl.length})`);
        
        document.getElementById('share-url').textContent = shareUrl;
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        copyToClipboard(shareUrl)
          .then(() => showSuccess('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼'))
          .catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            showError('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
            logDebug(`Clipboard copy failed: ${err.message}`);
          });
      } catch (error) {
        console.error('ç”Ÿæˆé“¾æ¥é”™è¯¯:', error);
        showError('ç”Ÿæˆé“¾æ¥å¤±è´¥: ' + error.message);
        logDebug(`Share URL generation error: ${error.message}`);
      }
    }
    
    // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
    function copyToClipboard(text) {
      return new Promise((resolve, reject) => {
        // ä¼˜å…ˆä½¿ç”¨ç°ä»£API
        if (navigator.clipboard) {
          logDebug('Using modern clipboard API');
          navigator.clipboard.writeText(text)
            .then(() => {
              logDebug('Clipboard write successful');
              resolve();
            })
            .catch(err => {
              logDebug(`Clipboard write error: ${err.message}`);
              reject(err);
            });
        } else {
          // ä¼ ç»Ÿæ–¹æ³•ä½œä¸ºåå¤‡
          logDebug('Using legacy clipboard method');
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          
          try {
            const successful = document.execCommand('copy');
            if (successful) {
              logDebug('Legacy clipboard copy successful');
              resolve();
            } else {
              logDebug('Legacy clipboard copy failed');
              reject(new Error('å¤åˆ¶å‘½ä»¤æ‰§è¡Œå¤±è´¥'));
            }
          } catch (err) {
            logDebug(`Legacy clipboard error: ${err.message}`);
            reject(err);
          } finally {
            document.body.removeChild(textarea);
          }
        }
      });
    }
    
    // é‡ç½®è§†å›¾
    function resetViewer() {
      if (currentModel) {
        camera.position.copy(initialCameraPosition);
        controls.target.copy(initialControlsTarget);
        controls.update();
        showSuccess('è§†å›¾å·²é‡ç½®');
        logDebug('View reset to initial position');
      } else {
        showError('æ²¡æœ‰åŠ è½½çš„æ¨¡å‹');
        logDebug('View reset failed: No model loaded');
      }
    }
    
    // éšè—å…ƒç´ 
    function hideElement(id) {
      document.getElementById(id).style.display = 'none';
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šå°†ArrayBufferè½¬æ¢ä¸ºBase64
    function arrayBufferToBase64(buffer) {
      let binary = '';
      const bytes = new Uint8Array(buffer);
      const len = bytes.byteLength;
      for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return window.btoa(binary);
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
      else return (bytes / 1048576).toFixed(2) + ' MB';
    }
    
    // è°ƒè¯•æ—¥å¿—
    function logDebug(message) {
      if (!DEBUG_MODE) return;
      
      const timestamp = new Date().toISOString().substr(11, 8);
      const logEntry = `[${timestamp}] ${message}`;
      debugInfo.push(logEntry);
      
      // é™åˆ¶æ—¥å¿—é•¿åº¦
      if (debugInfo.length > 50) {
        debugInfo.shift();
      }
      
      updateDebugDisplay();
      console.log(logEntry);
    }
    
    // æ›´æ–°è°ƒè¯•ä¿¡æ¯æ˜¾ç¤º
    function updateDebugDisplay() {
      const debugElement = document.getElementById('debug-info');
      if (!debugElement) return;
      
      debugElement.textContent = debugInfo.join('\n');
    }
    
    // åˆ‡æ¢è°ƒè¯•ä¿¡æ¯æ˜¾ç¤º
    function toggleDebugInfo() {
      const debugElement = document.getElementById('debug-info');
      debugElement.style.display = debugElement.style.display === 'block' ? 'none' : 'block';
    }
    
    // çª—å£å¤§å°è°ƒæ•´
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      logDebug(`Window resized to ${window.innerWidth} x ${window.innerHeight}`);
    });
    
    // æ¸²æŸ“å¾ªç¯
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
    
    // ä»URLå‚æ•°åŠ è½½æ¨¡å‹ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
    function loadModelFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const modelParam = urlParams.get('model');
      
      if (!modelParam) {
        logDebug('No model parameter found in URL');
        return;
      }
      
      logDebug(`Loading model from URL parameter (length: ${modelParam.length})`);
      
      // éªŒè¯DataURLæ ¼å¼
      const dataUrlPattern = /^data:model\/gltf-binary;base64,/;
      if (!dataUrlPattern.test(modelParam)) {
        showError('æ— æ•ˆçš„æ¨¡å‹é“¾æ¥æ ¼å¼');
        logDebug('Invalid model data URL format');
        return;
      }
      
      showLoading(true);
      
      // è§£ç Base64æ•°æ®
      try {
        const base64Data = modelParam.split(',')[1];
        const binaryString = window.atob(base64Data);
        const len = binaryString.length;
        const arrayBuffer = new ArrayBuffer(len);
        const uintArray = new Uint8Array(arrayBuffer);
        
        for (let i = 0; i < len; i++) {
          uintArray[i] = binaryString.charCodeAt(i);
        }
        
        // ä¿å­˜æ¨¡å‹æ•°æ®URL
        modelDataUrl = modelParam;
        
        // åŠ è½½æ¨¡å‹
        const loader = new GLTFLoader();
        loader.parse(arrayBuffer, '', function(gltf) {
          logDebug('Model loaded successfully from URL');
          loadModel(gltf.scene);
        }, function(error) {
          console.error('URLæ¨¡å‹åŠ è½½é”™è¯¯:', error);
          showLoading(false);
          showError(`ä»URLåŠ è½½æ¨¡å‹å¤±è´¥: ${error.message}`);
          logDebug(`URL model loading error: ${error.message}`);
        });
      } catch (error) {
        console.error('è§£æURLå‚æ•°æ—¶å‡ºé”™:', error);
        showLoading(false);
        showError(`è§£ææ¨¡å‹æ•°æ®å¤±è´¥: ${error.message}`);
        logDebug(`Error parsing URL parameter: ${error.message}`);
      }
    }
    
    // å¯¼å‡ºå…¨å±€å‡½æ•°ï¼Œä½¿å…¶å¯ä»¥ä»onclickå±æ€§è®¿é—®
    window.generateShareUrl = generateShareUrl;
    window.resetViewer = resetViewer;
    
    // åˆå§‹åŒ–ï¼šåªåœ¨æœ‰æœ‰æ•ˆURLå‚æ•°æ—¶åŠ è½½æ¨¡å‹
    logDebug(`Initializing app - URL: ${window.location.href}`);
    loadModelFromUrl(); // ç›´æ¥è°ƒç”¨ï¼Œæ— éœ€æ¡ä»¶åˆ¤æ–­
    
    // åˆå§‹åŒ–å®Œæˆ
    logDebug('App initialized successfully');
  </script>
</body>
</html>